<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="scalable_zoneæ˜¯zoneå…¶ä¸­ä¸€ç§ç±»å‹, åˆ†é…å †å†…å­˜ç®¡ç†è€…ï¼Œmallocï¼Œfreeç­‰å‡½æ•°çœŸæ­£çš„å…¥å£">
<meta property="og:type" content="article">
<meta property="og:title" content="iOSå†…å­˜-å †(libmalloc)-scalable_zone">
<meta property="og:url" content="http://yoursite.com/2019/12/16/iOSå†…å­˜-å †-libmalloc-magazine-zone/index.html">
<meta property="og:site_name" content="Tanner Jin">
<meta property="og:description" content="scalable_zoneæ˜¯zoneå…¶ä¸­ä¸€ç§ç±»å‹, åˆ†é…å †å†…å­˜ç®¡ç†è€…ï¼Œmallocï¼Œfreeç­‰å‡½æ•°çœŸæ­£çš„å…¥å£">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/s_zone.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/magazine.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/heap_region.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/s_zone&heap_region.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/free_lists.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/zone.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/last_heap_region.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/blocks_bitmap.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/tiny_get_region_from_depot1.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/tiny_get_region_from_depot2.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/pre_coalesce1.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/pre_coalesce2.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/next_coalesce1.png">
<meta property="og:image" content="http://yoursite.com/images/scalable_zone/next_coalesce2.png">
<meta property="og:updated_time" content="2020-01-07T22:23:43.692Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOSå†…å­˜-å †(libmalloc)-scalable_zone">
<meta name="twitter:description" content="scalable_zoneæ˜¯zoneå…¶ä¸­ä¸€ç§ç±»å‹, åˆ†é…å †å†…å­˜ç®¡ç†è€…ï¼Œmallocï¼Œfreeç­‰å‡½æ•°çœŸæ­£çš„å…¥å£">
<meta name="twitter:image" content="http://yoursite.com/images/scalable_zone/s_zone.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/12/16/iOSå†…å­˜-å †-libmalloc-magazine-zone/"/>





  <title>iOSå†…å­˜-å †(libmalloc)-scalable_zone | Tanner Jin</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Tanner Jin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/16/iOSå†…å­˜-å †-libmalloc-magazine-zone/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Tanner Jin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tanner Jin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iOSå†…å­˜-å †(libmalloc)-scalable_zone</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-12-16T17:42:07+08:00">
                2019-12-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/å†…å­˜/" itemprop="url" rel="index">
                    <span itemprop="name">å†…å­˜</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>scalable_zone</strong>æ˜¯zoneå…¶ä¸­ä¸€ç§ç±»å‹, åˆ†é…å †å†…å­˜ç®¡ç†è€…ï¼Œmallocï¼Œfreeç­‰å‡½æ•°çœŸæ­£çš„å…¥å£    </p>
<a id="more"></a>    
<h1 id="SZone"><a href="#SZone" class="headerlink" title="SZone"></a>SZone</h1><p>åœ¨<strong>zone</strong>ä¸­ï¼Œä¼šæ ¹æ®ç”³è¯·çš„å †å¤§å°é€‰æ‹©ä¸åŒrackè¿›è¡Œåˆ†é…</p>
<blockquote>
<p><strong>zone</strong>å’Œ<strong>rack</strong>å…³ç³»å¦‚ä¸‹å›¾   </p>
</blockquote>
<p><img src="\images\scalable_zone\s_zone.png" alt="">   </p>
<p> <strong>scalable_zone</strong>å³<strong>s_zone</strong>, æ‹¥æœ‰ä¸‰ä¸ªRack_Så¯¹è±¡ï¼Œåˆ†åˆ«ç”¨æ¥å¤„ç†ä¸åŒå¤§å°çš„å †å†…å­˜æ“ä½œ   </p>
<ul>
<li>tiny _rack å¤„ç†å°äº1009å­—èŠ‚çš„åˆ†é…   </li>
<li>small _rack å¤„ç†1009B~32KBçš„åˆ†é…(iOS 1009B~15KB)   </li>
<li>medium_rack å¤„ç†32(iOS 15)KB~8Mçš„åˆ†é…   </li>
<li>(å¦‚æœå¤§äº8Må†…å­˜çš„ç”³è¯·ï¼Œåˆ™é€šè¿‡ç³»ç»Ÿè°ƒç”¨ç”³è¯·)      </li>
</ul>
<p>ç›¸å…³å‡½æ•°    </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create_scalable_szone   	 <span class="comment">//  åˆ›å»ºzone</span></span><br><span class="line">szone_malloc   			     <span class="comment">// zone mallocå‡½æ•°å…¥å£</span></span><br><span class="line">szone_malloc_should_clear    <span class="comment">// åœ¨è¿™åˆ¤æ–­å¤§å°é€‰æ‹©rack</span></span><br></pre></td></tr></table></figure>
<h1 id="Rack"><a href="#Rack" class="headerlink" title="Rack"></a>Rack</h1><p>åœ¨<strong>rack</strong>ä¸­ï¼Œä¼šæ ¹æ®å½“å‰è¿è¡Œçº¿ç¨‹çš„æ‰€åœ¨çš„æ ¸é€‰æ‹©ä¸åŒMagazineè¿›è¡Œåˆ†é…   </p>
<blockquote>
<p><strong>rack</strong>å’Œ<strong>magazine</strong>å…³ç³»å¦‚ä¸‹</p>
</blockquote>
<p><img src="\images\scalable_zone\magazine.png" alt="">  </p>
<p> <strong>rack</strong>çš„å±æ€§<code>magazine*</code>æŒ‡å‘çš„æ˜¯magazineæ•°ç»„ã€‚è¯¥æ•°ç»„å†…å­˜åŒºåŸŸé€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>mach_vm_map</code>ç”³è¯·, ç”³è¯·å¤§å°magazineæ•°ç»„æ•°é‡+1    </p>
<p> magazinesæ•°é‡å³<code>rack</code>çš„<code>num_magazines</code>å±æ€§å¦‚ä½•ç¡®å®šå‘¢? ä»¥åŠä¸ºä»€ä¹ˆ+1ï¼Œå¤šå‡ºæ¥çš„é‚£ä¸ªmagazineç”¨æ¥å¹²å•¥çš„ï¼Ÿ   </p>
<blockquote>
<p><strong><code>num_magazines</code></strong>ç”±å½“å‰ä¸»æœºCPUæ ¸æ•°å†³å®š. å¦‚æœCPUæ ¸æ•°æ²¡æœ‰è®¾ç½®ï¼Œ<code>num_magazines=1</code>ï¼Œå¦‚æœå¤§äº1å°äº64ï¼Œåˆ™å–CPUæ ¸æ•°å€¼ï¼Œå¦‚æœå¤§äº64ï¼Œåˆ™å–64; è¿™ä¹ˆè®¾è®¡çš„ç›®çš„æ˜¯ä¸ºäº†çœŸæ­£å¹¶å‘çš„æ€§èƒ½</p>
<ul>
<li>å¤šæ ¸ä¸Šå¤šçº¿ç¨‹é€šè¿‡æ“ä½œä¸åŒçš„magazine(å¯¹å†…å­˜çš„mallocå’Œfreeç­‰), å¯ä»¥å‡å°‘lockçš„ä½¿ç”¨   </li>
<li>è®©å¤šæ ¸CPUçš„ç¼“å­˜å¾—åˆ°å……åˆ†åˆ©ç”¨ï¼Œæ¯ä¸ªæ ¸æ‹¥æœ‰è‡ªå·±çš„å¤šçº§ç¼“å­˜</li>
</ul>
</blockquote>
<blockquote>
<p><strong><code>+1</code></strong> æ˜¯ä¸ºäº†ç»™magazinesæ•°ç»„åŠ ä¸Šä¸€ä¸ª<code>depot magazine</code>, æ”¾ç½®åœ¨æ•°ç»„çš„é¦–ä½ç½®ä¸Šï¼Œå¹¶ä¸”<code>rack</code>çš„<code>magazines</code>æŒ‡å‘magazinesæ•°ç»„ç¬¬2ä¸ªå…ƒç´ çš„ä½ç½®   </p>
</blockquote>
<ul>
<li><code>depot magazine</code>æ˜¯å½“å‰çº¿ç¨‹æ‰€åœ¨çš„æ ¸å¯¹åº”çš„magazineæ— æ³•åˆ†é…å‡ºheapç©ºé—´æ—¶ï¼Œä¼šé€šè¿‡<code>depot magazine</code>åˆ†é…ã€‚åˆ†é…å‡ºçš„ç©ºé—´åœ°å€å¯¹åº”çš„heap regionä¼šæ·»åŠ åˆ°å½“å‰magazineä¸­ï¼Œåœ¨free blockå—åˆå¹¶çš„æ—¶å€™ï¼Œä¹Ÿä¼šç»™<code>depot magazine</code>æ·»åŠ heap region. å½“ç„¶åé¢ä¼šè¯¦ç»†è®²   </li>
</ul>
<p>ç›¸å…³å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rack_init    <span class="comment">// åˆå§‹åŒ–rackå’Œåˆ›å»ºmagazines</span></span><br><span class="line">tiny_malloc_should_clear       <span class="comment">// é€‰æ‹©tiny_rack magazine</span></span><br><span class="line">small_malloc_should_clear      <span class="comment">// é€‰æ‹©small_rack magazine</span></span><br></pre></td></tr></table></figure>
<h1 id="Magazine"><a href="#Magazine" class="headerlink" title="Magazine"></a>Magazine</h1><p><strong>magazine</strong>æ˜¯çœŸæ­£æ“ä½œå †å†…å­˜çš„å¯¹è±¡   </p>
<blockquote>
<p>magazineçš„ç»“æ„å¦‚ä¸‹, å…¶ä¸­æ¯ä¸ªå±æ€§æ³¨é‡Šåœ¨åé¢çš„mallocå’Œfreeè¿‡ç¨‹ä¸­éƒ½ä¼šè¯´åˆ°   </p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">magazine_s</span> &#123;</span></span><br><span class="line">	_malloc_lock_s magazine_lock MALLOC_CACHE_ALIGN;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// å½“å‰æ˜¯å¦åœ¨å‘å†…æ ¸ç”³è¯·heap region</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">boolean_t</span> alloc_underway;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// æœ€åä¸€æ¬¡freeçš„åœ°å€å’Œå¤§å°</span></span><br><span class="line">	<span class="keyword">void</span> *mag_last_free;</span><br><span class="line">	<span class="keyword">msize_t</span> mag_last_free_msize;	</span><br><span class="line">	<span class="comment">// æœ€åä¸€æ¬¡freeçš„åœ°å€æ‰€åœ¨çš„heap region</span></span><br><span class="line">	<span class="keyword">region_t</span> mag_last_free_rgn; </span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç©ºé—²é“¾è¡¨æ•°ç»„</span></span><br><span class="line">	<span class="keyword">free_list_t</span> mag_free_list[MAGAZINE_FREELIST_SLOTS];  <span class="comment">// MAGAZINE_FREELIST_SLOTS =&gt; 256</span></span><br><span class="line">	<span class="comment">// ç©ºé—²é“¾è¡¨æ•°ç»„bitä¿¡æ¯</span></span><br><span class="line">	<span class="keyword">uint32_t</span> mag_bitmap[MAGAZINE_FREELIST_BITMAP_WORDS]; <span class="comment">// MAGAZINE_FREELIST_BITMAP_WORDS =&gt; 8</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// æœ€åç”³è¯·çš„heap regionä¸­æœªä½¿ç”¨çš„å¤§å°</span></span><br><span class="line">	<span class="keyword">size_t</span> mag_bytes_free_at_end;</span><br><span class="line">	<span class="comment">// æœ€åç”³è¯·çš„heap regionçš„éšæœºèµ·å§‹åç§»æœªä½¿ç”¨çš„å¤§å°(ASLR)</span></span><br><span class="line">	<span class="keyword">size_t</span> mag_bytes_free_at_start;</span><br><span class="line">	<span class="comment">// æœ€åä¸€æ¬¡å‘å†…æ ¸ç”³è¯·çš„heap regionåœ°å€</span></span><br><span class="line">	<span class="keyword">region_t</span> mag_last_region;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// magazineå·²ç»åˆ†é…å‡ºå»çš„å¤§å°</span></span><br><span class="line">	<span class="keyword">size_t</span> mag_num_bytes_in_objects;</span><br><span class="line">	<span class="comment">// magazineæ€»å…±çš„heapå¤§å°(åŒ…æ‹¬åˆ†é…çš„å’Œæœªåˆ†é…çš„)</span></span><br><span class="line">	<span class="keyword">size_t</span> num_bytes_in_magazine;</span><br><span class="line">	<span class="comment">// heap region æ•°é‡</span></span><br><span class="line">	<span class="keyword">unsigned</span> mag_num_objects;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// heap regions metadataåŒå‘é“¾è¡¨é¦–å°¾èŠ‚ç‚¹</span></span><br><span class="line">	<span class="keyword">unsigned</span> recirculation_entries;</span><br><span class="line">	<span class="keyword">region_trailer_t</span> *firstNode;</span><br><span class="line">	<span class="keyword">region_trailer_t</span> *lastNode;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// é¡µå¡«å……æ— ç”¨æ•°æ®</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> pad[<span class="number">320</span> - <span class="number">14</span> - MAGAZINE_FREELIST_SLOTS -</span><br><span class="line">			(MAGAZINE_FREELIST_BITMAP_WORDS + <span class="number">1</span>) / <span class="number">2</span>];</span><br><span class="line">&#125; <span class="keyword">magazine_t</span>;</span><br></pre></td></tr></table></figure>
<h2 id="Heap-Region"><a href="#Heap-Region" class="headerlink" title="Heap Region"></a>Heap Region</h2><p><strong>å †å†…å­˜</strong> heap regionæ˜¯ç”¨æˆ·æ€mallocå†…å­˜çœŸæ­£çš„åŒºåŸŸ   </p>
<h3 id="è®¾è®¡"><a href="#è®¾è®¡" class="headerlink" title="è®¾è®¡"></a>è®¾è®¡</h3><p>æ•°æ®ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tiny_region</span> &#123;</span></span><br><span class="line">	<span class="comment">// Data; mallocç”³è¯·çš„ç©ºé—´åœ¨è¿™é‡Œé¢</span></span><br><span class="line">	<span class="keyword">tiny_block_t</span> blocks[NUM_TINY_BLOCKS];   <span class="comment">// sizeof(tiny_block_t) =&gt; 16;  NUM_TINY_BLOCKS =&gt; 64520</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Meta_Data;</span></span><br><span class="line">	<span class="keyword">region_trailer_t</span> trailer;</span><br><span class="line">	<span class="keyword">tiny_header_inuse_pair_t</span> pairs[CEIL_NUM_TINY_BLOCKS_WORDS];  <span class="comment">// blockså¯¹åº”çš„bitmap</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// å¯¹é½ç”¨çš„æ— ç”¨ç©ºé—´</span></span><br><span class="line">	<span class="keyword">uint8_t</span> pad[TINY_REGION_SIZE - (NUM_TINY_BLOCKS * <span class="keyword">sizeof</span>(<span class="keyword">tiny_block_t</span>)) - TINY_METADATA_SIZE];</span><br><span class="line">&#125; * <span class="keyword">tiny_region_t</span></span><br></pre></td></tr></table></figure>
<p>tiny_regionå¸ƒå±€ç»“æ„å¦‚ä¸‹   </p>
<p><img src="\images\scalable_zone\heap_region.png" alt=""></p>
<p>tiny_regioné€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>mach_vm_map</code>åˆ†é…, åˆ†é…å‡ºæ¥çš„ç©ºé—´åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†   </p>
<ul>
<li><p>Data   </p>
<blockquote>
<p>dataåŒºæŒ‰ç…§16ä¸ªå­—èŠ‚ä½œä¸ºä¸€ä¸ªblock, blockä¹Ÿæ˜¯mallocç”³è¯·çš„æœ€å°å•ä½<br>blockä¹Ÿåˆšå¥½èƒ½å­˜å‚¨ä¸¤ä¸ªæŒ‡é’ˆæ•°æ®ï¼Œå¯ä»¥ä½œä¸ºç©ºé—²é“¾è¡¨çš„ä¸€ä¸ªèŠ‚ç‚¹</p>
</blockquote>
</li>
<li><p>MetaData    </p>
<blockquote>
<p>metaDataå­˜å‚¨ç€dataåŒºçš„ä½¿ç”¨æƒ…å†µ(bitmap)ä»¥åŠheap_region prevå’Œnextçš„metaDataæŒ‡é’ˆ(åŒå‘é“¾è¡¨)</p>
</blockquote>
</li>
</ul>
<h3 id="å’Œmagazineçš„å…³ç³»"><a href="#å’Œmagazineçš„å…³ç³»" class="headerlink" title="å’Œmagazineçš„å…³ç³»"></a>å’Œmagazineçš„å…³ç³»</h3><ul>
<li><strong>magazine</strong>çš„<code>firstNode</code>å’Œ<code>lastNode</code>æŒ‡å‘heap region metaDataåŒå‘é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹   </li>
<li><strong>magazine</strong>çš„ <code>mag_last_region</code>æŒ‡å‘æœ€åä¸€æ¬¡magazineå‘å†…æ ¸ç”³è¯·çš„heap region</li>
</ul>
<blockquote>
<p>æè¿°å¦‚ä¸‹å›¾</p>
</blockquote>
<p><img src="\images\scalable_zone\s_zone&amp;heap_region.png" alt="">   </p>
<h2 id="Last-Free"><a href="#Last-Free" class="headerlink" title="Last_Free"></a>Last_Free</h2><p><code>magazine</code>çš„<code>last_freeç­‰å±æ€§</code>å‚¨å­˜ç€è¯¥<code>magazine</code>æœ€åä¸€æ¬¡freeçš„blockå—åœ°å€ï¼Œå—å¤§å°ï¼Œä»¥åŠå—åœ°å€çš„<code>heap region</code>åœ°å€</p>
<h2 id="Free-Lists"><a href="#Free-Lists" class="headerlink" title="Free_Lists"></a>Free_Lists</h2><p><code>free</code>è¿‡çš„å†…å­˜ä¼šä½œä¸ºèŠ‚ç‚¹å‚¨å­˜åœ¨ç©ºé—²é“¾è¡¨ä¸­ï¼Œè€Œ<code>free_lists</code>æ˜¯<code>magazine</code>çš„ç©ºé—²é“¾è¡¨æ•°ç»„ï¼Œæ•°ç»„å…ƒç´ ç©ºé—²é“¾è¡¨æŒ‰ç…§å†…å­˜å—å¤§å°é€’å¢   </p>
<blockquote>
<p>å¯¹äº<strong>tiny_rack</strong>æœ€å¤šåˆ†é…1008ä¸ªå­—èŠ‚ï¼Œå› æ­¤è¯¥rackä¸‹çš„æ¯ä¸ªmagazineçš„ç©ºé—²é“¾è¡¨æ•°ç»„ä¸ªæ•°æœ€å¤§ä¸º1008/16 + 1 = 64ï¼Œå³ç¬¬1ä¸ªç©ºé—²é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å†…å­˜å¤§å°ä¸º1block(=16B), ç¬¬2ä¸ªç©ºé—²é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å†…å­˜å¤§å°ä¸º2blocks(=32B)â€¦ç¬¬63ä¸ªç©ºé—²é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å†…å­˜ä¸º63blocks(=1008B), <strong>ä½†æœ€åä¸€ä¸ªç¬¬64ä¸ªç©ºé—²é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å†…å­˜å¤§äºç­‰äº64blocks(&gt;=1024Bï¼Œè¯¥é“¾è¡¨èŠ‚ç‚¹æ˜¯freeæ—¶åˆå¹¶äº§ç”Ÿ)</strong>    </p>
</blockquote>
<p>magazineä¸­çš„ç©ºé—²é“¾è¡¨æ•°ç»„ç»“æ„å¦‚ä¸‹   </p>
<p><img src="\images\scalable_zone\free_lists.png" alt="">   </p>
<ul>
<li><p>å¯¹äº16Bç©ºé—²é“¾è¡¨çš„èŠ‚ç‚¹ï¼Œåªå­˜å‚¨å‰é©±å’Œåç»§èŠ‚ç‚¹æŒ‡é’ˆ</p>
</li>
<li><p>å¯¹äºå¤§äº16å­—èŠ‚å°äºç­‰äº1008Bç©ºé—²é“¾è¡¨çš„èŠ‚ç‚¹ï¼Œå‰é¢16å­—èŠ‚å­˜å‚¨å‰é©±å’Œåç»§æŒ‡é’ˆï¼ŒæŒ‡é’ˆåä¸¤ä¸ªå­—èŠ‚å­˜å‚¨å—å¤§å°(å¦‚å›¾ï¼Œåœ¨freeè¿‡ç¨‹ä¸­å‘ä¸‹ä¸€ä¸ªblockåˆå¹¶æ—¶ç”¨åˆ°), æœ€åä¸¤ä¸ªå­—èŠ‚ä¹Ÿå‚¨å­˜ç€å—å¤§å°æ•°æ®(åœ¨freeè¿‡ç¨‹ä¸­å‘ä¸Šä¸€ä¸ªblockåˆå¹¶æ—¶ç”¨åˆ°). å¯¹åº”å‡½æ•°<code>TINY_FREE_SIZE</code></p>
</li>
<li><p>å¯¹äºæœ€åä¸€ä¸ªç©ºé—²é“¾è¡¨ï¼Œ<strong>æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯å¤§äºç­‰äº1024B</strong>. å…¶ä»–æŒ‡é’ˆï¼Œå—å¤§å°æ•°æ®å¸ƒå±€åŒä¸Š.</p>
</li>
</ul>
<h1 id="SZoneæ¶æ„æ€»ç»“"><a href="#SZoneæ¶æ„æ€»ç»“" class="headerlink" title="SZoneæ¶æ„æ€»ç»“"></a>SZoneæ¶æ„æ€»ç»“</h1><p>æ•´ä¸ªå®è§‚çš„æ¶æ„è®¾è®¡å°±è§£é‡Šåˆ°è¿™äº†ï¼Œå¦‚ä¸‹å›¾   </p>
<p><img src="\images\scalable_zone\zone.png" alt="">  </p>
<p>å½“ç„¶ä¸Šé¢çš„è§£é‡Šè¿˜æ˜¯å¤ªå®è§‚äº†ï¼Œå¾ˆå¤šå·§å¦™çš„è®¾è®¡æ“ä½œä»¥åŠåˆ†é…ç­–ç•¥éƒ½æ²¡æœ‰æåŠï¼Œæ¥ä¸‹æ¥å°±çœ‹çœ‹å…·ä½“çš„mallocå’Œfreeæ“ä½œ</p>
<hr>
<h1 id="Malloc-and-Free"><a href="#Malloc-and-Free" class="headerlink" title="Malloc and Free"></a>Malloc and Free</h1><h2 id="tiny-malloc"><a href="#tiny-malloc" class="headerlink" title="tiny_malloc"></a>tiny_malloc</h2><p><code>tiny_malloc_should_clear</code> æ˜¯æ•´ä¸ªåˆ†é…æµç¨‹, åœ¨å‡½æ•°<code>szone_malloc_should_clear</code>ä¸­é€šè¿‡åˆ¤æ–­ç”³è¯·çš„å†…å­˜å¤§å°è°ƒç”¨çš„ï¼Œå½“ç”³è¯·å¤§å°å°äº1009ä¸ªå­—èŠ‚æ—¶è°ƒç”¨   </p>
<p> <strong>msize</strong>   </p>
<blockquote>
<p>msizeè¡¨ç¤ºblockç”³è¯·å¤§å°å•ä½ï¼Œ1è¡¨ç¤ºç”³è¯·1ä¸ªblockï¼Œ16å­—èŠ‚ã€‚å½“ç”³è¯·å¤§å°ä¸æ»¡16Bï¼Œåˆ†é…1ä¸ªblockï¼Œç”³è¯·å¤§äº16Bå°äºç­‰äº32Bï¼Œåˆ†é…2ä¸ªblock, ä»¥æ­¤ç±»æ¨â€¦ </p>
</blockquote>
<blockquote>
<p>å…·ä½“å®ç°: msize = (size+15) &gt;&gt; 4 å³ msize = (size+15)/16   </p>
</blockquote>
<p>æ•´ä¸ªåˆ†é…ç®€ä»‹æµç¨‹å¦‚ä¸‹ï¼Œåé¢å¯¹æ¯ä¸ªæ­¥éª¤è¿‡ç¨‹ä¼šè¯¦ç»†ä»‹ç»   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">tiny_malloc_should_clear(<span class="keyword">rack_t</span> *rack, <span class="keyword">msize_t</span> msize, <span class="keyword">boolean_t</span> cleared_requested) &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 1</span></span><br><span class="line">	<span class="keyword">void</span> *ptr;</span><br><span class="line">	<span class="keyword">mag_index_t</span> mag_index = tiny_mag_get_thread_index() % rack-&gt;num_magazines;</span><br><span class="line">	<span class="keyword">magazine_t</span> *tiny_mag_ptr = &amp;(rack-&gt;magazines[mag_index]);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 2. </span></span><br><span class="line">	ptr = tiny_mag_ptr-&gt;mag_last_free;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (tiny_mag_ptr-&gt;mag_last_free_msize == msize) &#123;</span><br><span class="line">		tiny_mag_ptr-&gt;mag_last_free = <span class="literal">NULL</span>;</span><br><span class="line">		tiny_mag_ptr-&gt;mag_last_free_msize = <span class="number">0</span>;</span><br><span class="line">		tiny_mag_ptr-&gt;mag_last_free_rgn = <span class="literal">NULL</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (cleared_requested) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(ptr, <span class="number">0</span>, TINY_BYTES_FOR_MSIZE(msize));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ptr;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 3.</span></span><br><span class="line">	ptr = tiny_malloc_from_free_list(rack, tiny_mag_ptr, mag_index, msize);</span><br><span class="line">	<span class="keyword">if</span> (ptr) &#123;</span><br><span class="line">		<span class="keyword">if</span> (cleared_requested) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(ptr, <span class="number">0</span>, TINY_BYTES_FOR_MSIZE(msize));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ptr;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 4.</span></span><br><span class="line">	<span class="keyword">if</span> (tiny_get_region_from_depot(rack, tiny_mag_ptr, mag_index, msize)) &#123;</span><br><span class="line">		ptr = tiny_malloc_from_free_list(rack, tiny_mag_ptr, mag_index, msize);</span><br><span class="line">		<span class="keyword">if</span> (ptr) &#123;</span><br><span class="line">			<span class="keyword">if</span> (cleared_requested) &#123;</span><br><span class="line">				<span class="built_in">memset</span>(ptr, <span class="number">0</span>, TINY_BYTES_FOR_MSIZE(msize));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> ptr;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 5.</span></span><br><span class="line">	<span class="keyword">void</span> *fresh_region;</span><br><span class="line">	fresh_region = mvm_allocate_pages_securely(TINY_REGION_SIZE, TINY_BLOCKS_ALIGN, VM_MEMORY_MALLOC_TINY, rack-&gt;debug_flags);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (!fresh_region) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	ptr = tiny_malloc_from_region_no_lock(rack, tiny_mag_ptr, mag_index, msize, fresh_region);</span><br><span class="line">	<span class="keyword">return</span> ptr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li><code>current magazine</code> æ ¹æ®å½“å‰çº¿ç¨‹æ‰¾åˆ°tiny_rackå¯¹åº”tiny _magazine, ä¹‹åçš„åˆ†é…æµç¨‹æ“ä½œä¼šåŸºäºè¯¥magazine</li>
<li><code>last_free</code> åˆ¤æ–­è¯¥magazineçš„last_free cacheå¤§å°å’Œç”³è¯·å¤§å°æ˜¯å¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™åˆ†é…è¯¥åœ°å€</li>
<li><code>free_list of curretn magazine</code> 2æ­¥éª¤å¤±è´¥ï¼Œé€šè¿‡magazineçš„ç©ºé—²é“¾è¡¨åˆ†é…</li>
<li><code>free_list of depot magazine</code> 3æ­¥éª¤å¤±è´¥ï¼Œé€šè¿‡tiny _rackçš„depot _magazineçš„ç©ºé—²é“¾è¡¨åˆ†é…</li>
<li><code>mmap</code> 4æ­¥éª¤å¤±è´¥ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘å†…æ ¸ç”³è¯·ä¸€å—heap region, å¹¶ä»ä¸­åˆ†é…</li>
<li><code>return nil</code> 5æ­¥éª¤å¤±è´¥ï¼Œreturn nil</li>
</ol>
</blockquote>
<p>å¤§è‡´è¿‡ç¨‹å°±ä»‹ç»åˆ°è¿™äº†ï¼Œå¦‚æœå¯¹ç»†èŠ‚ä¸æ•¢å…´è¶£ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°<code>tiny_free</code>äº†è§£freeçš„è¿‡ç¨‹   </p>
<p>ä¸‹é¢å¼€å§‹ä»‹ç»è¯¦ç»†è¿‡ç¨‹</p>
<h3 id="1-current-magazine"><a href="#1-current-magazine" class="headerlink" title="1. current magazine"></a>1. current magazine</h3><p>å‡½æ•°<code>tiny_mag_get_thread_index</code> æ ¹æ®å½“å‰çº¿ç¨‹æ‰€åœ¨çš„CPUæ ¸ï¼Œè·å–<code>tiny_rack</code>çš„<code>magazines</code>çš„åç§»ï¼Œä»è€Œå¾—åˆ°å½“å‰æ ¸çš„<code>magazine</code></p>
<h3 id="2-last-free"><a href="#2-last-free" class="headerlink" title="2. last_free"></a>2. last_free</h3><p><code>magazine</code>å±æ€§<code>mag_last_free</code>, è¡¨ç¤ºè¯¥<code>magazine</code>æœ€åä¸€æ¬¡freeçš„åœ°å€(æ²¡æœ‰æ·»åŠ åˆ°ç©ºé—²é“¾è¡¨ä¸­)</p>
<p>é€šè¿‡ä¸Šä¸€æ­¥å¾—åˆ°çš„magazineï¼Œåˆ¤æ–­magazineçš„<code>mag_last_free_msize</code>å’Œå½“å‰ç”³è¯·å¤§å°(è½¬æ¢æˆmsize)æ˜¯å¦åŒ¹é…, å¦‚æœåŒ¹é…ï¼Œåˆ™è¿”å›è¯¥åœ°å€<code>mag_last_free</code></p>
<p>éªŒè¯demo</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>* ptr1 = <span class="built_in">malloc</span>(<span class="number">16</span>);    <span class="comment">// msize = 1</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%p\n"</span>, ptr1);</span><br><span class="line"><span class="built_in">free</span>(ptr1);</span><br><span class="line"><span class="keyword">void</span>* ptr2 = <span class="built_in">malloc</span>(<span class="number">1</span>);     <span class="comment">// msize = 1</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%p\n"</span>, ptr2);</span><br></pre></td></tr></table></figure>
<p>æ‰“å°å¯ä»¥å‘ç°ptr1å’Œptr2æ˜¯åŒä¸€åœ°å€   </p>
<blockquote>
<p>æ¼æ´åˆ©ç”¨<br>å¦‚æœ<code>cleared_requested</code>ä¸ºfalse, é‚£ä¹ˆmag _last _freeåˆ†é…å‡ºæ¥çš„å†…å­˜çš„å†…å®¹ä¸ä¼šè¢«æ¸…é™¤ï¼Œè¿˜æ˜¯ä¸Šä¸€ä¸ªå¯¹è±¡çš„å†…å®¹</p>
</blockquote>
<h3 id="3-free-list-of-curretn-magazine-é‡ç‚¹"><a href="#3-free-list-of-curretn-magazine-é‡ç‚¹" class="headerlink" title="3. free_list of curretn magazine(é‡ç‚¹)"></a>3. free_list of curretn magazine(é‡ç‚¹)</h3><p>å‡½æ•°<code>tiny_malloc_from_free_list</code>ä»å½“å‰<code>magazine</code>çš„ç©ºé—²é“¾è¡¨å’Œ<code>last heap region</code>ä¸­åˆ†é…ç©ºé—´</p>
<p>ä»ç©ºé—²é“¾è¡¨åˆ†é…ä¹Ÿæœ‰å¥½å‡ ä¸ªæ­¥éª¤    </p>
<blockquote>
<ol>
<li><code>free_list of msize</code> æ‰¾åˆ°msizeå¯¹åº”å¤§å°çš„ç©ºé—²é“¾è¡¨(ä¹‹å‰è¯´è¿‡magazineæ‹¥æœ‰ç©ºé—²é“¾è¡¨æ•°ç»„)ï¼Œæœ‰èŠ‚ç‚¹ï¼Œç›´æ¥åˆ†é…å¤´èŠ‚ç‚¹</li>
</ol>
</blockquote>
<blockquote>
<ol start="2">
<li><code>first free_list which is more than msize and has node</code> 1æ­¥éª¤å¤±è´¥ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”msizeå¤§, èŠ‚ç‚¹ä¸ä¸ºç©ºçš„ç©ºé—²é“¾è¡¨(bitæ“ä½œ)ï¼›æœ‰èŠ‚ç‚¹ï¼Œåˆ†é…èŠ‚ç‚¹ï¼Œå¹¶å°†å¤šä½™çš„å—å¤§å°æ·»åŠ åˆ°å¯¹åº”çš„ç©ºé—²é“¾è¡¨ä¸­</li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li><code>last free_list</code> æŸ¥çœ‹ç©ºé—²é“¾è¡¨æ•°ç»„çš„æœ€åä¸€ä¸ªç©ºé—²é“¾è¡¨(èŠ‚ç‚¹å†…å­˜å¤§äº1008B)æ˜¯å¦æœ‰èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰ï¼Œåˆ™åˆ†é…ï¼Œå¹¶å°†å¤šä½™çš„å—å¤§å°æ·»åŠ åˆ°å¯¹åº”çš„ç©ºé—²é“¾è¡¨ä¸­</li>
</ol>
</blockquote>
<blockquote>
<ol start="4">
<li><code>last heap region</code> 2ï¼Œ3æ­¥éª¤å¤±è´¥ï¼Œè¡¨ç¤ºå½“å‰magazineçš„ç©ºé—²é“¾è¡¨æ•°ç»„ä¸­æ¯”ç”³è¯·msizeå¤§çš„ç©ºé—²é“¾è¡¨éƒ½æ²¡æœ‰èŠ‚ç‚¹.<br>ä»<code>mag_last_region</code>ä¸­ç”³è¯·å†…å­˜ï¼Œè¯¥heap region æ˜¯è¯¥magazineæœ€åä¸€æ¬¡å‘å†…æ ¸ç”³è¯·çš„å †å†…å­˜åŒºåŸŸï¼Œæœ‰äº›å†…å­˜blockè¿˜æ²¡æœ‰ç”¨è¿‡(freeè¿‡çš„å­˜åœ¨ç©ºé—²é“¾è¡¨ä¸­)</li>
</ol>
</blockquote>
<blockquote>
<ol start="5">
<li>4æ­¥éª¤å¤±è´¥ï¼Œè¡¨ç¤ºæœ€åä¸€å—heapå†…å­˜åŒºåŸŸä¹Ÿæ²¡æœ‰å¤šä½™çš„ç©ºé—´äº†ï¼Œæ•´ä¸ªå¤§çš„æ­¥éª¤ç»“æŸ</li>
</ol>
</blockquote>
<blockquote>
<ol start="6">
<li><code>return_tiny_alloc</code>å¦‚æœç”³è¯·æˆåŠŸï¼Œåšä¸€äº›æ”¶å°¾å·¥ä½œï¼Œå³å°†èŠ‚ç‚¹ä»ç©ºé—²é“¾è¡¨ä¸­ç§»é™¤ï¼Œå°†å¤šä½™çš„å—ä½œä¸ºèŠ‚ç‚¹æ·»åŠ åˆ°å¯¹åº”çš„ç©ºé—²é“¾è¡¨ä¸­ï¼Œè®¾ç½®blockå¯¹åº”çš„bitmapä¿¡æ¯</li>
</ol>
</blockquote>
<p><strong>ä¸‹é¢æ˜¯ä»ç©ºé—²é“¾è¡¨åˆ†é…çš„è¯¦ç»†è¿‡ç¨‹</strong>    </p>
<h4 id="1-ä»ç©ºé—²é“¾è¡¨æ•°ç»„ä¸­æ‰¾åˆ°å¤§å°åŒ¹é…çš„ç©ºé—²é“¾è¡¨"><a href="#1-ä»ç©ºé—²é“¾è¡¨æ•°ç»„ä¸­æ‰¾åˆ°å¤§å°åŒ¹é…çš„ç©ºé—²é“¾è¡¨" class="headerlink" title="1. ä»ç©ºé—²é“¾è¡¨æ•°ç»„ä¸­æ‰¾åˆ°å¤§å°åŒ¹é…çš„ç©ºé—²é“¾è¡¨"></a>1. ä»ç©ºé—²é“¾è¡¨æ•°ç»„ä¸­æ‰¾åˆ°å¤§å°åŒ¹é…çš„ç©ºé—²é“¾è¡¨</h4><ol>
<li><p>è·å–ç”³è¯·å¤§å°msizeå¯¹åº”çš„ç©ºé—²é“¾è¡¨åç§»(slot)ï¼Œå¾—åˆ°å¯¹åº”msizeçš„ç©ºé—²é“¾è¡¨</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">grain_t</span></span><br><span class="line">tiny_slot_from_msize(<span class="keyword">msize_t</span> msize)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// msize &gt; 63(tiny limit) ? 63 : msize-1</span></span><br><span class="line">	<span class="keyword">return</span> (!msize || (msize &gt; NUM_TINY_SLOTS) ? NUM_TINY_SLOTS : msize - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>å¦‚æœç©ºé—²é“¾è¡¨æœ‰èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹ä¸ºè¿™æ¬¡ç”³è¯·å†…å­˜åœ°å€ï¼Œå¹¶å°†è¯¥èŠ‚ç‚¹ä»è¯¥ç©ºé—²é“¾è¡¨ç§»é™¤. ç§»é™¤è¯¥èŠ‚ç‚¹ï¼Œç©ºé—²é“¾è¡¨å¦‚æœæ²¡æœ‰èŠ‚ç‚¹ï¼Œè®¾ç½®ç©ºé—²é“¾è¡¨metadataçš„bitmapå¯¹åº”çš„bitä½ä¸º0  </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (next) &#123;</span><br><span class="line">	next-&gt;previous = ptr-&gt;previous;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	BITMAPV_CLR(tiny_mag_ptr-&gt;mag_bitmap, slot);  <span class="comment">// è®¾ç½®bitä½</span></span><br><span class="line">&#125;</span><br><span class="line">the_slot-&gt;p = next;   <span class="comment">// (å°†ç©ºé—²é“¾è¡¨æŒ‡å‘ä¸‹ä¸€èŠ‚ç‚¹)</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>è¿™é‡Œçš„tiny_mallocçš„bitmapç”¨äº†8ä¸ªå­—èŠ‚64bitä½è¡¨ç¤ºè¯¥magazineçš„64ä¸ªç©ºé—²é“¾è¡¨ï¼Œ0è¡¨ç¤ºé“¾è¡¨æ— èŠ‚ç‚¹ï¼Œ1è¡¨ç¤ºæœ‰é“¾è¡¨èŠ‚ç‚¹</p>
</blockquote>
<ol start="3">
<li>å¦‚æœè¯¥ç©ºé—²é“¾è¡¨æ²¡æœ‰èŠ‚ç‚¹ï¼Œæ¥ç€èµ°ä¸‹é¢æµç¨‹ğŸ‘‡   </li>
</ol>
<h4 id="2-ä»ç¬¬ä¸€ä¸ªå¤§äºç”³è¯·msizeçš„ç©ºé—²é“¾è¡¨ç”³è¯·"><a href="#2-ä»ç¬¬ä¸€ä¸ªå¤§äºç”³è¯·msizeçš„ç©ºé—²é“¾è¡¨ç”³è¯·" class="headerlink" title="2. ä»ç¬¬ä¸€ä¸ªå¤§äºç”³è¯·msizeçš„ç©ºé—²é“¾è¡¨ç”³è¯·"></a>2. ä»ç¬¬ä¸€ä¸ªå¤§äºç”³è¯·msizeçš„ç©ºé—²é“¾è¡¨ç”³è¯·</h4><p>æ¯”å¦‚ç”³è¯·çš„msizeä¸º2ï¼Œä½†æ˜¯msizeä¸º2å¯¹åº”çš„ç©ºé—²é“¾è¡¨æ²¡æœ‰èŠ‚ç‚¹ï¼Œè¿™æ—¶å€™æŸ¥çœ‹msizeä¸º3ï¼Œ4ï¼Œ5â€¦63çš„ç©ºé—²é“¾è¡¨</p>
<ol>
<li><p>å–å‡ºè¡¨ç¤ºå¤§äºmsizeçš„bitmap  </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bitmap = ((<span class="keyword">uint64_t</span> *)(tiny_mag_ptr-&gt;mag_bitmap))[<span class="number">0</span>] &amp; ~((<span class="number">1U</span>LL &lt;&lt; slot) - <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>å°äºmsizeå¯¹åº”çš„bitä½è®¾ç½®ä¸º1
</code></pre><ol start="2">
<li><p>æ‰¾åˆ°ç¬¬ä¸€ä¸ªbitä¸ä¸º0çš„bitmapçš„ä½ç½®(slotåç§»)</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slot = BITMAPV_CTZ(bitmap);    <span class="comment">// __builtin_ctzl(è¿”å›ä»ç¬¬0ä½å¼€å§‹bitä¸º0çš„bitä¸ªæ•°)</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p>é€šè¿‡1å’Œ2æ“ä½œå¾—åˆ°ç¬¬ä¸€ä¸ªå¤§äºç”³è¯·msizeçš„ç©ºé—²é“¾è¡¨åç§». ç„¶åå’Œä¸Šé¢ä¸€æ ·åˆ¤æ–­èŠ‚ç‚¹æœ‰å€¼ä¸å¦ï¼Œç§»é™¤èŠ‚ç‚¹ç­‰æ“ä½œ</p>
</li>
<li><p>å¦‚æœæœ‰èŠ‚ç‚¹ï¼Œå–å¾—èŠ‚ç‚¹å¤§å°(ä¸Šé¢è¯´çš„å¤§äº16Bçš„blockèŠ‚ç‚¹ä¸­ä¼šå­˜å‚¨è¯¥èŠ‚ç‚¹å¤§å°æ•°æ®)ï¼Œå°†è¯¥èŠ‚ç‚¹å¤šä½™çš„blockä½œä¸ºèŠ‚ç‚¹æ·»åŠ åˆ°å¯¹åº”å¤§å°çš„ç©ºé—²é“¾è¡¨ä¸­</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msize(ç”³è¯·å¤§å°)</span><br><span class="line">this_msize = TINY_FREE_SIZE(ptr);     <span class="comment">// å–å¾—è¯¥èŠ‚ç‚¹çš„blockå¤§å°</span></span><br><span class="line">leftover_msize = this_msize - msize;  <span class="comment">// å¤šä½™å—å¤§å°</span></span><br><span class="line">tiny_free_list_add_ptr;			<span class="comment">// å°†å¤šä½™å—æŒ‰ç…§å¤§å°æ·»åŠ åˆ°å¯¹åº”çš„ç©ºé—²é“¾è¡¨</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="5">
<li>å¦‚æœè¯¥ç©ºé—²é“¾è¡¨æ²¡æœ‰èŠ‚ç‚¹ï¼Œæ¥ç€èµ°ä¸‹é¢æµç¨‹ğŸ‘‡</li>
</ol>
<h4 id="3-ä»æœ€å¤§çš„ç©ºé—²é“¾è¡¨-ç¬¬64ä¸ª-ä¸­ç”³è¯·"><a href="#3-ä»æœ€å¤§çš„ç©ºé—²é“¾è¡¨-ç¬¬64ä¸ª-ä¸­ç”³è¯·" class="headerlink" title="3. ä»æœ€å¤§çš„ç©ºé—²é“¾è¡¨(ç¬¬64ä¸ª)ä¸­ç”³è¯·"></a>3. ä»æœ€å¤§çš„ç©ºé—²é“¾è¡¨(ç¬¬64ä¸ª)ä¸­ç”³è¯·</h4><p>æ‰¾åˆ°ç©ºé—²é“¾è¡¨æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå³æœ€å¤§çš„ç©ºé—²é“¾è¡¨(èŠ‚ç‚¹å¤§äºç­‰äº1024B, &gt;=64 Blocks)ä¸­æŸ¥çœ‹æ˜¯å¦æœ‰èŠ‚ç‚¹</p>
<ul>
<li><p>å¦‚æœæœ‰, å’Œä¸Šé¢ä¸€æ ·ï¼Œä»é“¾è¡¨ä¸­ç§»é™¤è¯¥èŠ‚ç‚¹ï¼Œè®¾ç½®bitmap, å°†è¯¥èŠ‚ç‚¹å¤šä½™çš„ç©ºé—´ä½œä¸ºæ–°èŠ‚ç‚¹æ·»åŠ åˆ°å¯¹åº”çš„ç©ºé—²é“¾è¡¨ä¸­   </p>
</li>
<li><p>å¦‚æœæ²¡æœ‰, æ¥ç€èµ°ä¸‹é¢æµç¨‹ğŸ‘‡   </p>
</li>
</ul>
<h4 id="4-ä»æœ€åä¸€ä¸ªheap-regionä¸­åˆ†é…"><a href="#4-ä»æœ€åä¸€ä¸ªheap-regionä¸­åˆ†é…" class="headerlink" title="4. ä»æœ€åä¸€ä¸ªheap regionä¸­åˆ†é…"></a>4. ä»æœ€åä¸€ä¸ªheap regionä¸­åˆ†é…</h4><blockquote>
<p>å¦‚æœä¸Šè¿°ä»ç©ºé—²é“¾è¡¨ç”³è¯·å †å†…å­˜æ“ä½œå¤±è´¥ï¼Œè¡¨ç¤ºä¹‹å‰æ‰€æœ‰çš„<code>heap region</code>ä¸­æ²¡æœ‰ä¸€å—è¿ç»­çš„å¤§äºç­‰äºç”³è¯·å¤§å°çš„ç©ºé—´ï¼Œå› ä¸ºä¹‹å‰çš„<code>heap region</code>çš„blocksè¦ä¹ˆåœ¨ç©ºé—²é“¾è¡¨ä¸­(freeè¿‡çš„)ï¼Œè¦ä¹ˆåœ¨ä½¿ç”¨ä¸­. </p>
</blockquote>
<p>åªæœ‰æœ€åä¸€ä¸ª<code>heap region</code>ä¸­çš„blocksæ˜¯åœ¨ç©ºé—²é“¾è¡¨ä¸­æˆ–è€…åœ¨ä½¿ç”¨ä¸­ï¼Œ<strong>æˆ–è€…ä»æœªä½¿ç”¨è¿‡</strong>    </p>
<p>å› æ­¤ä»æœ€åä¸€ä¸ª<code>heap region</code>ä¸­ç”³è¯·å †å†…å­˜    </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tiny_mag_ptr-&gt;mag_bytes_free_at_end &gt;= TINY_BYTES_FOR_MSIZE(msize)) &#123;</span><br><span class="line">	ptr = (<span class="keyword">tiny_free_list_t</span> *)((<span class="keyword">uintptr_t</span>)TINY_REGION_END(tiny_mag_ptr-&gt;mag_last_region) - tiny_mag_ptr-&gt;mag_bytes_free_at_end);</span><br><span class="line">	tiny_mag_ptr-&gt;mag_bytes_free_at_end -= TINY_BYTES_FOR_MSIZE(msize);</span><br><span class="line">	<span class="keyword">if</span> (tiny_mag_ptr-&gt;mag_bytes_free_at_end) &#123;</span><br><span class="line">		<span class="comment">// let's add an in use block after ptr to serve as boundary</span></span><br><span class="line">		set_tiny_meta_header_in_use_1((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)ptr + TINY_BYTES_FOR_MSIZE(msize));</span><br><span class="line">	&#125;</span><br><span class="line">	this_msize = msize;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">goto</span> return_tiny_alloc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>mag_bytes_free_at_end</code>è¡¨ç¤ºè¯¥<code>heap region</code>è¿˜å‰©ä½™çš„æœªä½¿ç”¨è¿‡çš„å¤§å°</li>
<li><code>TINY_REGION_END(tiny_mag_ptr-&gt;mag_last_region)</code>è¡¨ç¤ºè¯¥<code>heap region</code>çš„blocksçš„å°¾ä½ç½®</li>
</ul>
<p>å¦‚ä¸‹å›¾   </p>
<p><img src="\images\scalable_zone\last_heap_region.png" alt="">   </p>
<blockquote>
<p>ç»¿è‰²å—è¡¨ç¤ºä»æœªä½¿ç”¨è¿‡ï¼Œæ˜¯è¿ç»­çš„. <code>mag_bytes_free_at_end</code>å³è¡¨ç¤ºç»¿è‰²å—çš„å¤§å°<br>è“è‰²è¡¨ç¤ºæ­£åœ¨ä½¿ç”¨ä¸­<br>é»„è‰²çš„å—æ˜¯ä½¿ç”¨è¿‡ä¸”<strong>free</strong>äº†çš„ï¼Œåœ¨<code>free_list</code>ä¸­    </p>
</blockquote>
<ol>
<li>å°†æœ€å‰é¢çš„ç»¿è‰²å—ä½ç½®ä½œä¸ºæ­¤æ¬¡ç”³è¯·çš„heapåœ°å€</li>
<li><code>mag_bytes_free_at_end</code>å‡æ‰æ­¤æ¬¡ç”³è¯·çš„msizeå¤§å°   </li>
<li>å¦‚æœè¯¥<code>heap region</code>è¿˜æœ‰block,è®¾ç½®åˆšåˆšç”³è¯·å—å¯¹åº”åœ¨metadataçš„bitmapçš„è¾¹ç•Œbitä½ä¸º1, ä½œä¸ºä¸‹æ¬¡ç”³è¯·çš„èµ·å§‹ä½ç½®    </li>
</ol>
<p><strong>Blocks Bitmapè®¾ç½®å¦‚ä¸‹</strong>   </p>
<p><img src="\images\scalable_zone\blocks_bitmap.png" alt="">    </p>
<p>å…¶ä¸­æ¯8ä¸ªå­—èŠ‚(64bit)è¡¨ç¤º32ä¸ªblocks   </p>
<blockquote>
<ul>
<li><p>å‰é¢çš„32bit(è“è‰²)è¡¨ç¤º32ä¸ªblockçš„block_header(å¯ä»¥ç†è§£ä¸ºè¿ç»­blocksèµ·å§‹block)<br>bit <code>Â·Â·Â·10010001 (block_header) | Â·Â·Â·10010001 (in use)</code> è¡¨ç¤ºç¬¬1ä¸ªblockåˆ°ç¬¬4ä¸ªblockä¸€æ®µæ­£åœ¨ä½¿ç”¨çš„è¿ç»­ç©ºé—´ï¼ŒåŒç†ç¬¬5ä¸ªblockåˆ°ç¬¬7ä¸ªblockä¹Ÿæ˜¯å¦‚æ­¤</p>
</li>
<li><p>åé¢32bit(ç»¿è‰²)ä¸­çš„bitè¡¨ç¤ºblocksæ˜¯å¦æ­£åœ¨ä½¿ç”¨(1è¡¨ç¤ºä½¿ç”¨ä¸­ï¼Œ0è¡¨ç¤ºæœªä½¿ç”¨)<br>bit <code>Â·Â·Â·10010001 (block_header) | Â·Â·Â·10000001 (in use)</code> è¡¨ç¤ºç¬¬1ä¸ªblockåˆ°ç¬¬4ä¸ªblockä¸€æ®µæ­£åœ¨ä½¿ç”¨çš„è¿ç»­ç©ºé—´ï¼Œ<strong>ä½†ç¬¬5ä¸ªblockåˆ°ç¬¬7ä¸ªblockè¡¨ç¤ºçš„æ˜¯freeçš„è¿ç»­ç©ºé—´</strong></p>
</li>
</ul>
</blockquote>
<p>å¯¹åº”å‡½æ•°   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set_tiny_meta_header_in_use</span><br><span class="line">set_tiny_meta_header_in_use_1(ç”¨æ¥è®¾ç½®è¾¹ç•Œ <span class="keyword">or</span> msize == <span class="number">1</span>)</span><br><span class="line">set_tiny_meta_header_free</span><br></pre></td></tr></table></figure>
<blockquote>
<p> é€šè¿‡<code>heap region</code>çš„bitmapä¿¡æ¯ï¼Œåœ¨freeçš„æ—¶å€™ï¼Œå¯ä»¥çŸ¥é“freeåœ°å€ç”³è¯·çš„å†…å­˜å¤§å°</p>
</blockquote>
<h4 id="5-æ”¶å°¾å·¥ä½œ"><a href="#5-æ”¶å°¾å·¥ä½œ" class="headerlink" title="5. æ”¶å°¾å·¥ä½œ"></a>5. æ”¶å°¾å·¥ä½œ</h4><ol>
<li>åœ¨ä¸Šé¢çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæˆåŠŸåˆ†é…äº†ç©ºé—´ï¼Œåˆ™è®°å½•ä¿¡æ¯</li>
</ol>
<ul>
<li>è®¾ç½®è¯¥<code>magazine</code>çš„<code>mag_num_objects</code>åŠ ä¸€ï¼Œè¯¥<code>magazine</code>å­—èŠ‚ä½¿ç”¨<code>mag_num_bytes_in_objects</code>åŠ ä¸Šmsize*16</li>
<li><p>è®¾ç½®å½“å‰åˆ†é…çš„å †åœ°å€æ‰€åœ¨çš„<code>heap region</code>çš„metadata. åŒ…æ‹¬è¯¥<code>heap region</code>çš„å­—èŠ‚ä½¿ç”¨<code>trailer-&gt;bytes_used</code>å’Œbitmapè®¾ç½®(ä¸Šé¢è§£é‡Šäº†)   </p>
<p>  <strong>é€šè¿‡å †åœ°å€ï¼Œè·å–è¯¥åœ°å€æ‰€åœ¨çš„<code>heap region</code>çš„åœ°å€</strong> (freeæ—¶åªéœ€è¦åœ°å€çš„åŸå› )   </p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TINY_BLOCKS_ALIGN = 20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TINY_REGION_FOR_PTR(_p) ((void *)((uintptr_t)(_p) &amp; ~((1 &lt;&lt; TINY_BLOCKS_ALIGN) - 1)))</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>å»æ‰ <code>NUM _TINY _BLOCKS * TINY _QUANTUM</code>(64520*16) æœ€å¤šèƒ½å ç”¨çš„20ä¸ªbitä½. å¾—åˆ°regionåŸºåœ°å€   </p>
<p>è¿™æ˜¯å› ä¸ºåœ¨å‘å†…æ ¸ç”³è¯·<code>heap region</code>æ—¶ï¼ŒæŒ‡å®šäº†å †åœ°å€å†…å­˜å¯¹é½ä¸º<code>(1&lt;&lt;20)-1</code>ï¼Œé¡¾æ‰€æœ‰çš„<code>heap region</code>èµ·å§‹åœ°å€å20ä¸ªbitä¸º0. ç³»ç»Ÿè°ƒç”¨å‡½æ•°<code>mach_vm_map</code>çš„ç¬¬4ä¸ªå‚æ•°ä¸ºå†…å­˜å¯¹é½</p>
</blockquote>
<ol start="2">
<li>åˆ†é…ç©ºé—´å¤±è´¥ï¼Œèµ°ä¸‹é¢çš„æµç¨‹ğŸ‘‡</li>
</ol>
<h3 id="4-free-list-of-depot-magazine"><a href="#4-free-list-of-depot-magazine" class="headerlink" title="4. free_list of depot magazine"></a>4. free_list of depot magazine</h3><p><code>tiny_get_region_from_depot</code>å‡½æ•°ä»<code>depot magazine</code>ä¸­å¯»æ‰¾ä¸€ä¸ªèƒ½åˆ†é…msizeç©ºé—²é“¾è¡¨(å¤§äºç­‰äºmsize)çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ‰€åœ¨çš„<code>heap region</code>, å°†è¯¥<code>heap region</code>ä»<code>depot magazine</code>ç§»åˆ°<code>current magazine</code></p>
<p><strong>ç„¶ååœ¨ä»<code>current magazine</code>ä¸­åˆ†é…(å³ä¸Šä¸€æ­¥æµç¨‹)</strong>   </p>
<p>å‡½æ•°æµç¨‹å¦‚ä¸‹   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">tiny_get_region_from_depot</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">	tiny_find_msize_region;</span><br><span class="line">	recirc_list_extract;</span><br><span class="line">	tiny_free_detach_region;</span><br><span class="line">	tiny_free_reattach_region;</span><br><span class="line">	recirc_list_splice_first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>tiny_find_msize_region</code>å‡½æ•°ä»<code>depot magazine</code>çš„ç©ºé—²é“¾è¡¨æ•°ç»„ä¸­å¯»æ‰¾ä¸€ä¸ªå¤§äºç­‰äºç”³è¯·å¤§å°msizeçš„èŠ‚ç‚¹(è¿‡ç¨‹åŒä¸Šé¢<code>free_lists</code>ä¸€æ ·)ï¼Œé€šè¿‡èŠ‚ç‚¹åœ°å€å¾—åˆ°è¯¥èŠ‚ç‚¹çš„<code>heap region</code>(<code>TINY_REGION_FOR_PTR</code>å‡½æ•°, ä¸Šé¢ä¹Ÿè¯´è¿‡)</li>
<li><code>recirc_list_extract</code>å‡½æ•°å°†ä¸Šä¸€æ­¥å¾—åˆ°çš„<code>heap region</code>ä»<code>depot magazine</code>åŒå‘é“¾è¡¨<code>region_trailer</code>ä¸­ç§»é™¤</li>
<li><code>tiny_free_detach_region</code>é€šè¿‡éå†<code>heap region</code>blocksçš„bitmapï¼Œå°†freeçš„blocksä»<code>depot magazine</code>çš„ç©ºé—²é“¾è¡¨ä¸­ç§»é™¤</li>
<li><code>tiny_free_reattach_region</code>é€šè¿‡éå†<code>heap region</code>blocksçš„bitmapï¼Œå°†freeçš„blocksæ·»åŠ åˆ°<code>current magazine</code>çš„ç©ºé—²é“¾è¡¨ä¸­</li>
<li><code>recirc_list_splice_first</code>å°†<code>heap region</code>ä½œä¸ºèŠ‚ç‚¹æ·»åŠ åˆ°<code>current magazine</code>çš„åŒå‘é“¾è¡¨<code>region_trailer</code>ä¸­   </li>
</ol>
<p>å˜åŒ–è¿‡ç¨‹å¦‚ä¸‹(<strong>msize=2</strong>)   </p>
<p>å˜åŒ–ä¹‹å‰</p>
<p><img src="\images\scalable_zone\tiny_get_region_from_depot1.png" alt=""> </p>
<p>å˜åŒ–ä¹‹å</p>
<p><img src="\images\scalable_zone\tiny_get_region_from_depot2.png" alt=""> </p>
<p><strong>å¦‚æœä¸Šé¢çš„<code>tiny_find_msize_region</code>å¤±è´¥ï¼Œè¡¨ç¤º<code>depot magazine</code>ç©ºé—²é“¾è¡¨æ•°ç»„ä¸­ä¹Ÿæ²¡æœ‰å¤§äºç­‰äºmsizeçš„èŠ‚ç‚¹. æ¥ç€èµ°ä¸‹é¢çš„æµç¨‹ğŸ‘‡</strong></p>
<h3 id="5-mmap"><a href="#5-mmap" class="headerlink" title="5. mmap"></a>5. mmap</h3><p><code>mvm_allocate_pages_securely</code>å‘å†…æ ¸ç”³è¯·ä¸€å—<code>heap region</code>   </p>
<ul>
<li>å¤±è´¥ï¼Œ<code>return nil</code></li>
<li>æˆåŠŸï¼Œ<code>tiny_malloc_from_region_no_lock</code>å‡½æ•°ä»åˆšåˆšç”³è¯·çš„<code>heap region</code>ä¸­åˆ†é…msize</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">tiny_malloc_from_region_no_lock</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// aligned_address = heap regionåœ°å€</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 1. è®¾ç½®magazineæœ€åä¸€æ¬¡å‘å†…æ ¸ç”³è¯·çš„heapåœ°å€</span></span><br><span class="line">	tiny_mag_ptr-&gt;mag_last_region = aligned_address;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 2. ASLR éšæœºåç§»ï¼ˆoffset_msizeçš„blocksä¸¢å¼ƒä¸ä½¿ç”¨ï¼‰</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> CONFIG_ASLR_INTERNAL</span></span><br><span class="line">		<span class="keyword">int</span> offset_msize = malloc_entropy[<span class="number">0</span>] &amp; TINY_ENTROPY_MASK</span><br><span class="line">	#<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">int</span> offset_msize = <span class="number">0</span>; </span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 3. å¾—åˆ°ç”³è¯·åœ°å€</span></span><br><span class="line">	ptr = aligned_address + offset_msize;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 4. è®¾ç½®metadataä¿¡æ¯</span></span><br><span class="line">	<span class="comment">/// è®¾ç½®heap regionçš„bitä¿¡æ¯</span></span><br><span class="line">	set_tiny_meta_header_in_use(ptr, msize);  <span class="comment">// è®¾ç½®ä½¿ç”¨bit</span></span><br><span class="line">	set_tiny_meta_header_in_use_1;  <span class="comment">// è®¾ç½®è¾¹ç•Œbit</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/// è®¾ç½®magazineä¿¡æ¯</span></span><br><span class="line">	mag_num_objects  </span><br><span class="line">	mag_num_bytes_in_objects</span><br><span class="line">	num_bytes_in_magazine</span><br><span class="line">	mag_bytes_free_at_end</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 5. å°†heap regionæ·»åŠ åˆ°magazineçš„nodeåŒå‘é“¾è¡¨ä¸­</span></span><br><span class="line">	recirc_list_splice_last;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è‡³æ­¤ï¼Œæ•´ä¸ªtiny_mallocçš„è¿‡ç¨‹å°±åˆ†æå®Œäº†ï¼Œä¸‹é¢çœ‹çœ‹å¯¹åº”çš„freeè¿‡ç¨‹tiny _freeå§</strong></p>
<h2 id="tiny-free"><a href="#tiny-free" class="headerlink" title="tiny_free"></a>tiny_free</h2><p>å‡½æ•°<code>free()</code>é€šè¿‡å‡½æ•°<code>find_registered_zone</code>æ‰¾åˆ°é‡Šæ”¾åœ°å€æ‰€åœ¨çš„<code>zone</code>, å†è°ƒç”¨<code>zone</code>çš„<code>basic_zone</code>åœ¨zoneåˆ›å»ºæ—¶æ³¨å†Œçš„<code>free</code>å‡½æ•°    </p>
<p><code>s_zone</code>æ³¨å†Œçš„freeå‡½æ•°ä¸º<code>szone_free</code>ï¼Œ<code>szone_free</code>ä¼šé€šè¿‡é‡Šæ”¾åœ°å€<code>ptr</code>å°è¯•è·å–<code>ptr</code>æ‰€åœ¨çš„<code>heap region</code>, åŒ…æ‹¬<code>tiny</code>, <code>small</code>, <code>medium</code>. å¦‚æœ<code>tiny</code>(&lt;1009B)è¿”å›çš„<code>heap region</code>ä¸ä¸ºç©º, åˆ™èµ°<code>free_tiny</code>å‡½æ•°  </p>
<p>å¯¹äº<code>tiny_free</code>å‡½æ•°ä¸»è¦æœ‰3ä¸ªæ­¥éª¤ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_tiny</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	ptr  			<span class="comment">// å½“å‰é‡Šæ”¾åœ°å€</span></span><br><span class="line">	msize 			<span class="comment">// å½“å‰é‡Šæ”¾å †å¤§å°</span></span><br><span class="line">	tiny_region 	<span class="comment">// å½“å‰é‡Šæ”¾åœ°å€æ‰€åœ¨çš„heap regionåœ°å€</span></span><br><span class="line">	</span><br><span class="line">	Â·</span><br><span class="line">	Â·</span><br><span class="line">	Â·</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 1. éªŒè¯Double Free</span></span><br><span class="line">	msize = get_tiny_meta_header(ptr, &amp;is_free);   </span><br><span class="line">	<span class="keyword">if</span> (is_free) &#123;</span><br><span class="line">		free_tiny_botch(rack, ptr);    <span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 2. è®¾ç½®last_free</span></span><br><span class="line">	<span class="keyword">if</span> (msize &lt; <span class="number">16</span>) &#123;</span><br><span class="line">		<span class="keyword">void</span> *ptr2 = tiny_mag_ptr-&gt;mag_last_free;  <span class="comment">// Might be NULL</span></span><br><span class="line">		<span class="keyword">msize_t</span> msize2 = tiny_mag_ptr-&gt;mag_last_free_msize;</span><br><span class="line">		<span class="keyword">region_t</span> rgn2 = tiny_mag_ptr-&gt;mag_last_free_rgn;</span><br><span class="line">		</span><br><span class="line">		tiny_mag_ptr-&gt;mag_last_free = ptr;</span><br><span class="line">		tiny_mag_ptr-&gt;mag_last_free_msize = msize;</span><br><span class="line">		tiny_mag_ptr-&gt;mag_last_free_rgn = tiny_region;</span><br><span class="line">		</span><br><span class="line">		msize = msize2;</span><br><span class="line">		ptr = ptr2;</span><br><span class="line">		tiny_region = rgn2;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 3. é‡Šæ”¾last_free</span></span><br><span class="line">	tiny_free_no_lock(..., tiny_region, ptr, msize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>æ ¹æ®<code>heap region</code>çš„metadataçš„bitmapï¼ŒéªŒè¯ptræ˜¯å¦æ˜¯freeè¿‡çš„(In Useå¯¹åº”çš„bitä½ä¸º0)</li>
<li>è®¾ç½®free_cache, å¦‚æœé‡Šæ”¾å†…å­˜å°äº16ä¸ªmsize,åˆ™æ­¤æ¬¡é‡Šæ”¾åœ°å€è®¾ç½®æˆ<code>last_free</code>, ç„¶åå¯¹ä¸Šä¸€æ¬¡çš„<code>last_free</code>æ“ä½œ</li>
<li>é‡Šæ”¾<code>last_free</code></li>
</ol>
</blockquote>
<p>çœŸæ­£freeå †å†…å­˜åœ¨<code>tiny_free_no_lock</code>å‡½æ•°ä¸­</p>
<h3 id="tiny-free-no-lock"><a href="#tiny-free-no-lock" class="headerlink" title="tiny_ free_ no_lock"></a>tiny_ free_ no_lock</h3><p>æ­£å¸¸åªéœ€è¦å°†é‡Šæ”¾åœ°å€ä½œä¸ºèŠ‚ç‚¹æ·»åŠ åˆ°å¯¹åº”å¤§å°çš„ç©ºé—²é“¾è¡¨ä¸­ï¼Œç„¶åè®¾ç½®åœ°å€å—å¯¹åº”çš„bitmapä¿¡æ¯å°±è¡Œäº†.</p>
<p>ä½†æ˜¯åœ¨<code>libmalloc</code>çš„<code>free</code>ä¸­æœ‰ä¸ª<strong>åˆå¹¶è¿‡ç¨‹ï¼Œåˆå¹¶ä¸ºäº†æ•´ç†å†…å­˜ç¢ç‰‡ï¼Œä¸ºäº†ä¹‹ååˆ†é…æ›´å¤§çš„å†…å­˜æä¾›å¯èƒ½</strong>   </p>
<p><code>tiny_ free_ no_lock</code>å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">tiny_free_no_lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 1. å‘å‰åˆå¹¶</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 2. å‘ååˆå¹¶</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 3. æ›´æ–°bitmapä¿¡æ¯ï¼Œå°†åˆå¹¶ç»“æœæ·»åŠ åˆ°å¯¹åº”å¤§å°çš„ç©ºé—²é“¾è¡¨ä¸­ï¼›æ›´æ–°magazineçš„ä¿¡æ¯æ•°æ®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å‘å‰åˆå¹¶-ä¸Šä¸€ä¸ªblock"><a href="#å‘å‰åˆå¹¶-ä¸Šä¸€ä¸ªblock" class="headerlink" title="å‘å‰åˆå¹¶(ä¸Šä¸€ä¸ªblock)"></a>å‘å‰åˆå¹¶(ä¸Šä¸€ä¸ªblock)</h4><p>å¯¹äºå¤§äº16å­—èŠ‚ç©ºé—²é“¾è¡¨çš„èŠ‚ç‚¹ï¼Œå‰é¢16å­—èŠ‚å­˜å‚¨å‰é©±å’Œåç»§æŒ‡é’ˆï¼ŒæŒ‡é’ˆåä¸¤ä¸ªå­—èŠ‚å­˜å‚¨å—å¤§å°msize, æœ€åä¸¤ä¸ªå­—èŠ‚ä¹Ÿå‚¨å­˜ç€å—å¤§å°msize. å¯¹åº”å‡½æ•°<code>TINY_FREE_SIZE</code></p>
<p><strong>åˆå¹¶å‰å¦‚ä¸‹å›¾</strong></p>
<p><img src="\images\scalable_zone\pre_coalesce1.png" alt="">   </p>
<blockquote>
<p>å›¾ä¸­çº¢è‰²è¡¨ç¤ºå½“å‰é‡Šæ”¾çš„å†…å­˜, ç»¿è‰²è¡¨ç¤ºåœ¨ç©ºé—²é“¾è¡¨çš„å†…å­˜</p>
</blockquote>
<p><strong>åˆå¹¶åå¦‚ä¸‹å›¾</strong>    </p>
<p><img src="\images\scalable_zone\pre_coalesce2.png" alt="">  </p>
<blockquote>
<p>æ­¤æ—¶è¿˜æ²¡åŠ å…¥åˆ°ç©ºé—²é“¾è¡¨ä¸­ï¼Œå¾…ä¸‹é¢å‘ååˆå¹¶æ­¥éª¤å®Œæˆï¼Œæ‰åŠ å…¥åˆ°ç©ºé—²é“¾è¡¨ä¸­</p>
</blockquote>
<p>åˆå¹¶è¿‡ç¨‹å¦‚ä¸‹</p>
<ol>
<li><p><code>block_header</code>:<br> åˆ¤æ–­å½“å‰<code>free ptr</code>åœ°å€çš„å‰ä¸€ä¸ªblockæ˜¯å¦æ˜¯<code>block_header</code></p>
<blockquote>
<p>æ ¹æ®bitmapåˆ¤æ–­ï¼Œå³å›¾ä¸­100å‰ä¸€ä¸ªbitæ˜¯å¦ä¸º1 </p>
<p>å¦‚æœæ˜¯1åˆ™<code>free ptr</code>å‰1ä¸ªblockä¸ºå•ç‹¬çš„è¿ç»­çš„ç©ºé—´ï¼Œå³ä¸º<code>block_header</code><br>  å¦‚æœä¸æ˜¯1, åˆ™è¡¨ç¤º<code>free ptr</code>å‰nä¸ªblockä¸ºå•ç‹¬çš„è¿ç»­çš„ç©ºé—´<code>previous</code>(å¦‚å›¾æ‰€ç¤º)</p>
</blockquote>
</li>
<li><p><code>pre_size</code>:<br> å¦‚æœå‰ä¸€ä¸ªblockæ˜¯block_ headerï¼Œé‚£ä¹ˆè¿ç»­ç©ºé—´<code>previous</code>å¤§å°<code>pre_size</code>ç­‰äº1    </p>
<pre><code>å¦‚æœä¸æ˜¯block_headerï¼Œè¡¨ç¤ºè¿ç»­ç©ºé—´`previous`å¤§å°å¤§äº1 
</code></pre><blockquote>
<p>å¯¹äºå¤§äº1çš„blocks, å¦‚æœè¯¥è¿ç»­ç©ºé—´åœ¨ç©ºé—²é“¾è¡¨ä¸­ï¼Œè¯¥ç©ºé—´çš„æœ€åä¸¤ä¸ªå­—èŠ‚å‚¨å­˜ç€è¯¥åŒºåŸŸæ‰€å ç”¨çš„blockå¤§å°(å¦‚å›¾<code>pre_size</code>=2) </p>
<p>å¦‚æœè¯¥ç©ºé—´ä¸åœ¨ç©ºé—²é“¾è¡¨ä¸­(ä¸éœ€è¦åˆå¹¶)ï¼Œä¹Ÿæš‚æ—¶å…ˆè¯»æœ€åä¸¤ä¸ªå­—èŠ‚ä½œä¸º<code>pre_size</code>ï¼Œä¹‹åå†é€šè¿‡bitmapçš„<code>block_header==1</code>è¿›è¡ŒéªŒè¯   </p>
</blockquote>
</li>
</ol>
<ol start="3">
<li><p><code>éªŒè¯</code>:<br> æ ¹æ®ä¸Šä¸€æ­¥è·å–åˆ°çš„<code>pre_size</code>ï¼Œå°†<code>free_ptr</code>å¯¹åº”çš„bitä½å‘å‰ç§»åŠ¨<code>pre_size</code>, å¾—åˆ°<code>previous</code>çš„èµ·å§‹ä½ç½®å¯¹åº”çš„bit. å½“è¯¥bitä½çš„<code>block_header</code>=1, <code>In Use</code>=0 è¡¨ç¤ºè¯¥è¿ç»­åŒºé—´åœ¨ç©ºé—²é“¾è¡¨ä¸­éœ€è¦åˆå¹¶(å¦‚ä¸Šå›¾æ‰€ç¤º) </p>
<blockquote>
<p>ä½†å¦‚æœ<code>Â·Â·Â·1010100Â·Â·Â·(block_header)  Â·Â·Â·0010100Â·Â·Â·(in use)</code>è¿™ç§æƒ…å†µ. <code>100</code>è¿˜æ˜¯è¦é‡Šæ”¾çš„å†…å­˜, å‰é¢çš„<code>10</code>å†…å­˜å—ä¸ºä½¿ç”¨ä¸­ï¼Œè¿™æ—¶å€™å¦‚æœè¯¥å†…å­˜å—æœ€åä¸¤ä¸ªå­—èŠ‚ä¸º4. é‚£ä¹ˆåœ¨åˆå¹¶ä¸­å°±ä¼šå–<code>100</code>çš„å‰é¢4ä¸ªå—ä½œä¸ºä¸€ä¸ªè¿ç»­çš„åŒºé—´ï¼Œå¯¹åº”bitä¸º<code>1010(block_header) 0010(in use)</code> ï¼Œæ­¤æ—¶éªŒè¯ä¹Ÿæ˜¯æ­£ç¡®çš„. é‚£ä¹ˆä½¿ç”¨ä¸­çš„<code>10</code>ä¸¤ä¸ªå†…å­˜blockå°±ä¼šè¢«åˆå¹¶</p>
</blockquote>
<p> <strong>è§£å†³</strong>: éªŒè¯è¯¥è¿ç»­åŒºåŸŸå¤§å°</p>
<blockquote>
<p>ä»<code>1010(block_header) 0010(in use)</code>å†…å­˜èµ·å§‹ä½ç½®è®¡ç®—å¾—åˆ°çš„å¤§å°ä¸º2ï¼Œä¸4ä¸ç¬¦åˆ. éªŒè¯å¤±è´¥ ï¼ˆç©ºé—²é“¾è¡¨èŠ‚ç‚¹çš„å‰é©±åç»§æŒ‡é’ˆä¹‹å(16å­—èŠ‚ä¹‹å)å­˜å‚¨ç€å—å¤§å°msizeï¼‰</p>
</blockquote>
</li>
<li><p><code>åˆå¹¶</code>:</p>
<p> å¦‚æœ<code>free ptr</code>å‰é¢çš„è¿ç»­ç©ºé—´<code>previous</code>åœ¨ç©ºé—²é“¾è¡¨ä¸­ï¼Œå°†<code>free ptr</code>å’Œ<code>previous</code>è¿›è¡Œåˆå¹¶    </p>
<blockquote>
<ol>
<li>å…ˆå°†<code>previous</code>ä»å½“å‰ç©ºé—²é“¾è¡¨ä¸­ç§»é™¤   </li>
<li>æ¸…é™¤<code>free ptr</code>å†…å­˜åŒºåŸŸå¯¹åº”çš„bitmapä¿¡æ¯</li>
<li><code>free ptr</code>å’Œ<code>previous</code>å¤§å°å’Œä½œä¸ºæ–°freeå¤§å°</li>
<li><code>free ptr</code> = <code>previous</code> </li>
</ol>
</blockquote>
</li>
</ol>
<h4 id="å‘ååˆå¹¶-ä¸‹ä¸€ä¸ªblock"><a href="#å‘ååˆå¹¶-ä¸‹ä¸€ä¸ªblock" class="headerlink" title="å‘ååˆå¹¶(ä¸‹ä¸€ä¸ªblock)"></a>å‘ååˆå¹¶(ä¸‹ä¸€ä¸ªblock)</h4><p>å¯¹äºå¤§äº16å­—èŠ‚ç©ºé—²é“¾è¡¨çš„èŠ‚ç‚¹ï¼Œå‰é¢16å­—èŠ‚å­˜å‚¨å‰é©±å’Œåç»§æŒ‡é’ˆï¼ŒæŒ‡é’ˆåä¸¤ä¸ªå­—èŠ‚å­˜å‚¨å—å¤§å°msize</p>
<p><strong>åˆå¹¶å‰å¦‚ä¸‹å›¾</strong></p>
<p><img src="\images\scalable_zone\next_coalesce1.png" alt="">   </p>
<p><strong>åˆå¹¶åå¦‚ä¸‹å›¾</strong>    </p>
<p><img src="\images\scalable_zone\next_coalesce2.png" alt="">  </p>
<blockquote>
<p>åˆå¹¶è¿‡ç¨‹å’Œä¸Šé¢ç±»ä¼¼</p>
</blockquote>
<h4 id="åˆå¹¶ç»“æŸ"><a href="#åˆå¹¶ç»“æŸ" class="headerlink" title="åˆå¹¶ç»“æŸ"></a>åˆå¹¶ç»“æŸ</h4><p>åˆå¹¶ç»“æŸåæ›´æ–°åˆå¹¶å†…å­˜å—å¯¹åº”çš„bitmapä¿¡æ¯ï¼Œå°†åˆå¹¶çš„å†…å­˜å—æ·»åŠ åˆ°å¯¹åº”çš„ç©ºé—²é“¾è¡¨ä¸­<br>æ›´æ–°<code>magazine</code>æ•°æ®ï¼Œæ›´æ–°å½“å‰<code>heap region</code>çš„metadataä¿¡æ¯</p>
<p><strong>è‡³æ­¤ï¼Œæ•´ä¸ª<code>tiny_free</code>è¿‡ç¨‹ç»“æŸ</strong></p>
<hr>
<h1 id="æ€»ç»“æ€è€ƒ"><a href="#æ€»ç»“æ€è€ƒ" class="headerlink" title="æ€»ç»“æ€è€ƒ"></a>æ€»ç»“æ€è€ƒ</h1><p><code>libmalloc</code>ç¡®å®æ˜¯ä¸€ä¸ªä¼˜ç§€çš„ç”¨æˆ·å †ç®¡ç†åº“. é‡Œé¢æœ‰è®¸å¤šä¼˜ç§€çš„åˆ†é…ç­–ç•¥è®¾è®¡, å¹¶å‘çš„æ”¯æŒè®¾è®¡ï¼Œå†…å­˜ç¢ç‰‡ç®¡ç†ï¼Œæ€§èƒ½è€ƒè™‘ç­‰ç­‰. ä¹‹å‰çœ‹æœ‰äº›ä¹¦è¯´è¿‡çš„å †è®¾è®¡çš„é—®é¢˜ï¼Œå®ƒéƒ½æœ‰å¯¹åº”çš„è§£å†³ç­–ç•¥    </p>
<ol>
<li><p>å¤šæ ¸å¹¶å‘æ€§è®¾è®¡</p>
<blockquote>
<p>é‡‡ç”¨ä¸€æ ¸å¯¹åº”ä¸€ä¸ªå †ç®¡ç†<code>magazine</code>ï¼Œè®©è¯¥æ ¸ä¸‹çš„è™šæ‹Ÿå¹¶å‘æ€§èƒ½æ›´å¥½</p>
</blockquote>
</li>
<li><p>å †ç®¡ç†æœ€å°å•ä½ </p>
<blockquote>
<p>å°†å †å†…å­˜åˆ’åˆ†ä¸ºå¤šä¸ªç›¸åŒå¤§å°çš„<code>block</code>, å³å †ä¸­çš„æœ€å°å•ä½, 16B, æ›´åˆ©äºç©ºé—²é“¾è¡¨ç®¡ç†</p>
</blockquote>
</li>
<li><p>é‡‡ç”¨ç©ºé—²é“¾è¡¨æ•°ç»„</p>
<blockquote>
<p>å°†ä¸åŒå¤§å°çš„<code>free</code>äº†çš„å †ç©ºé—´ç»„æˆä¸åŒç©ºé—²é“¾è¡¨å½¢æˆä¸€ä¸ªç©ºé—²é“¾è¡¨æ•°ç»„ï¼ŒåŠ å¿«åˆ†é…æ•ˆç‡ï¼Œæ›´æ˜“äºç®¡ç†</p>
</blockquote>
</li>
<li><p>å¤šçº§åˆ†é…ç­–ç•¥</p>
<blockquote>
<ul>
<li><code>last free</code>å±æ€§ç¼“å­˜;   </li>
<li>ç©ºé—²é“¾è¡¨åŒ¹é…;   </li>
<li>å¯»æ‰¾æ›´å¤§çš„ç©ºé—²é“¾è¡¨(åˆ†å‰²å¤„ç†å¤šä½™çš„ç©ºé—´);   //  å¯¹åº”bitä¼˜åŒ–ç®—æ³•æ‰¾åˆ°ç©ºé—²é“¾è¡¨</li>
<li>æœ€åä¸€ä¸ªå¯åˆ©ç”¨çš„å †</li>
<li>ä»“åº“<code>depot magazine</code></li>
<li>å†…æ ¸</li>
</ul>
</blockquote>
</li>
<li><p>bitmapè®°å½•<code>block</code>ä¿¡æ¯</p>
<blockquote>
<p>ä½¿ç”¨64bitè¡¨ç¤º32ä¸ª<code>blocks</code>ä¿¡æ¯; <code>Block Header</code> and <code>In Use</code></p>
</blockquote>
</li>
<li><p>ç³»ç»Ÿè°ƒç”¨è¿”å›å¯¹é½çš„<code>heap region</code></p>
<blockquote>
<p>å¯¹é½20bit, ä¸€ä¸ª<code>heap region</code>ä¸­blocksèƒ½å ç”¨çš„ç©ºé—´ï¼Œé€šè¿‡å †å†…å­˜ä¸­çš„åœ°å€å»æ‰å20bitå¯ä»¥è·å¾—è¯¥<code>heap region</code>çš„åŸºåœ°å€</p>
</blockquote>
</li>
<li><p>åˆå¹¶ã€‚ç¢ç‰‡å†…å­˜æ•´ç†    </p>
<blockquote>
<p><code>free</code>è¿‡ç¨‹ä¸­ï¼Œæ•´ç†å‰åå†…å­˜ç¢ç‰‡. å°†ç¢ç‰‡å†…å­˜åˆå¹¶åœ¨ä¸€èµ·ï¼Œåˆ©ç”¨åˆ†é…æ›´å¤§çš„å †å†…å­˜</p>
</blockquote>
</li>
<li><p>ç­‰ç­‰</p>
</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/16/iOSå†…å­˜-å †-libmalloc-ç®€ä»‹/" rel="next" title="iOSå†…å­˜-å †(libmalloc)-ç®€ä»‹">
                <i class="fa fa-chevron-left"></i> iOSå†…å­˜-å †(libmalloc)-ç®€ä»‹
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Tanner Jin" />
            
              <p class="site-author-name" itemprop="name">Tanner Jin</p>
              <p class="site-description motion-element" itemprop="description">å°˜ä¸–é—´ä¸€è¿·é€”å°ç å†œ</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/TannerJin" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/p/1005055237152442/home?from=page_100505&mod=TAB&is_hot=1#place" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-Weibo"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SZone"><span class="nav-number">1.</span> <span class="nav-text">SZone</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Rack"><span class="nav-number">2.</span> <span class="nav-text">Rack</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Magazine"><span class="nav-number">3.</span> <span class="nav-text">Magazine</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Heap-Region"><span class="nav-number">3.1.</span> <span class="nav-text">Heap Region</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#è®¾è®¡"><span class="nav-number">3.1.1.</span> <span class="nav-text">è®¾è®¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å’Œmagazineçš„å…³ç³»"><span class="nav-number">3.1.2.</span> <span class="nav-text">å’Œmagazineçš„å…³ç³»</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Last-Free"><span class="nav-number">3.2.</span> <span class="nav-text">Last_Free</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Free-Lists"><span class="nav-number">3.3.</span> <span class="nav-text">Free_Lists</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SZoneæ¶æ„æ€»ç»“"><span class="nav-number">4.</span> <span class="nav-text">SZoneæ¶æ„æ€»ç»“</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Malloc-and-Free"><span class="nav-number">5.</span> <span class="nav-text">Malloc and Free</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#tiny-malloc"><span class="nav-number">5.1.</span> <span class="nav-text">tiny_malloc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-current-magazine"><span class="nav-number">5.1.1.</span> <span class="nav-text">1. current magazine</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-last-free"><span class="nav-number">5.1.2.</span> <span class="nav-text">2. last_free</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-free-list-of-curretn-magazine-é‡ç‚¹"><span class="nav-number">5.1.3.</span> <span class="nav-text">3. free_list of curretn magazine(é‡ç‚¹)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-ä»ç©ºé—²é“¾è¡¨æ•°ç»„ä¸­æ‰¾åˆ°å¤§å°åŒ¹é…çš„ç©ºé—²é“¾è¡¨"><span class="nav-number">5.1.3.1.</span> <span class="nav-text">1. ä»ç©ºé—²é“¾è¡¨æ•°ç»„ä¸­æ‰¾åˆ°å¤§å°åŒ¹é…çš„ç©ºé—²é“¾è¡¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-ä»ç¬¬ä¸€ä¸ªå¤§äºç”³è¯·msizeçš„ç©ºé—²é“¾è¡¨ç”³è¯·"><span class="nav-number">5.1.3.2.</span> <span class="nav-text">2. ä»ç¬¬ä¸€ä¸ªå¤§äºç”³è¯·msizeçš„ç©ºé—²é“¾è¡¨ç”³è¯·</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-ä»æœ€å¤§çš„ç©ºé—²é“¾è¡¨-ç¬¬64ä¸ª-ä¸­ç”³è¯·"><span class="nav-number">5.1.3.3.</span> <span class="nav-text">3. ä»æœ€å¤§çš„ç©ºé—²é“¾è¡¨(ç¬¬64ä¸ª)ä¸­ç”³è¯·</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-ä»æœ€åä¸€ä¸ªheap-regionä¸­åˆ†é…"><span class="nav-number">5.1.3.4.</span> <span class="nav-text">4. ä»æœ€åä¸€ä¸ªheap regionä¸­åˆ†é…</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-æ”¶å°¾å·¥ä½œ"><span class="nav-number">5.1.3.5.</span> <span class="nav-text">5. æ”¶å°¾å·¥ä½œ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-free-list-of-depot-magazine"><span class="nav-number">5.1.4.</span> <span class="nav-text">4. free_list of depot magazine</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-mmap"><span class="nav-number">5.1.5.</span> <span class="nav-text">5. mmap</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tiny-free"><span class="nav-number">5.2.</span> <span class="nav-text">tiny_free</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#tiny-free-no-lock"><span class="nav-number">5.2.1.</span> <span class="nav-text">tiny_ free_ no_lock</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#å‘å‰åˆå¹¶-ä¸Šä¸€ä¸ªblock"><span class="nav-number">5.2.1.1.</span> <span class="nav-text">å‘å‰åˆå¹¶(ä¸Šä¸€ä¸ªblock)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å‘ååˆå¹¶-ä¸‹ä¸€ä¸ªblock"><span class="nav-number">5.2.1.2.</span> <span class="nav-text">å‘ååˆå¹¶(ä¸‹ä¸€ä¸ªblock)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#åˆå¹¶ç»“æŸ"><span class="nav-number">5.2.1.3.</span> <span class="nav-text">åˆå¹¶ç»“æŸ</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æ€»ç»“æ€è€ƒ"><span class="nav-number">6.</span> <span class="nav-text">æ€»ç»“æ€è€ƒ</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tanner Jin</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
